# !/usr/bin/env python3
# -*- coding: utf-8 -*-
# Author: Mr.Bingo@猎户实验室

from lib.plugins.base_deliver import BaseDeliver
import json
import time
import smtplib
import logging
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
from email.header import Header

'''
{
  "deliver": {
    "name":"email",
    "module_name":"deliver_email",
    "smtp": "smtp.ym.163.com",
    "sender_address": "noreply@oddboy.cn",
    "sender_password": "!4nDqXC27Co",
    "receiver": [{
      "address":"songgongbin@tass.com.cn"
    },{
      "address":"ob@oddboy.cn"
    }]
  }
}
'''
class Deliver(BaseDeliver):
    def __init__(self, conf):
        self.conf = conf
        self.deliver_name = conf['deliver']['name']
        self.smtp_server = conf['deliver']['smtp_server']
        self.smtp_port = conf['deliver']['smtp_port']
        self.sender = conf['deliver']['sender_address']
        self.password = conf['deliver']['sender_password']
        self.receiver = []
        for r in conf['deliver']['receiver']:
            self.receiver.append(r['address'])
        # print(self.receiver)
        self.result = False

    def _process(self, vulninfo):
        '''
        实际发送邮件
        :param vulninfo: 漏洞信息
        :return:
        '''
        if len(self.receiver)<=0 or len(vulninfo)<=0:
            print('\t[ %s ] - Error | no receiver or no vuln' % (self.deliver_name ))
            return self.result

        # 整理vulninfo
        # print(json.dumps(vulninfo, indent=2))

        vulnmsg = []
        for vuln in vulninfo:
            # print(json.dumps(vuln, indent=2))
            vulnmsg.append(  ("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("漏洞来源",str(vuln["dataSource"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("漏洞编号",str(vuln["vulnID"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("来源URL",str(vuln["sourceURL"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("影响范围",str(vuln["affects"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("漏洞类型",str(vuln["problemtype"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("参考链接",str(vuln["references"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("描述信息",str(vuln["description"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("基本评分",str(vuln["impact_baseScore"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("严重程度",str(vuln["impact_baseSeverity"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("整体评分",str(vuln["impact_impactScore"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("可利用度",str(vuln["impact_exploitabilityScore"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("发布时间",str(vuln["publishedDate"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("修改时间",str(vuln["lastModifiedDate"])))\
                            +("<tr><td width=100>%s</td><td>%s</td></tr>\n" % ("获取时间",str(vuln["lastTouchTime"]))))

        msg = '<table border="1" cellspacing="0" cellpadding="5" width=750px margin:auto>%s</table>' % "<tr height = 30></tr>".join(vulnmsg)

        mail_msg = """
        <html>
        <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        </head>
        <body><div width=750 margin: auto;>
        %s
        </div></body>
        </html>
        """%msg

        # print(msg)
        # with open("msg.html","w") as fp:
        #     fp.write(msg)

        message = MIMEMultipart('alternative')
        message['From'] = self.sender
        message['To'] = ",".join(self.receiver)
        subject = '最新漏洞和CVE告警信息 - %s'% time.strftime("%Y-%m-%d %H:%M")
        message['Subject'] = Header(subject, 'utf-8')
        message.attach(MIMEText(mail_msg, 'html', 'utf-8'))

        # 发送
        try:
            print('\t[ %s ] - Sending (%s)' % (self.deliver_name, " | ".join(self.receiver)))
            smtpObj = smtplib.SMTP_SSL(self.smtp_server, self.smtp_port)
            smtpObj.login(self.sender, self.password)
            smtpObj.sendmail(self.sender, self.receiver, message.as_string())
            smtpObj.quit()
            print('\t[ %s ] - Success'%(self.deliver_name))
            self.result = True
        except smtplib.SMTPException as e:
            print('\t[ %s ] - Error' % (self.deliver_name))
            self.result = False
            logging.debug(e)
        return self.result